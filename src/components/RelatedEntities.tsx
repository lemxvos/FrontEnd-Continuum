/**
 * RelatedEntities - Mostra entidades relacionadas
 * 
 * Entidades relacionadas sÃ£o aquelas mencionadas juntas em notas
 * (co-ocorrÃªncias)
 */

import { useState, useEffect } from "react";
import api from "@/lib/axios";
import { Skeleton } from "@/components/ui/skeleton";
import { Button } from "@/components/ui/button";
import { Network, ArrowRight } from "lucide-react";
import { useNavigate } from "react-router-dom";
import { cn } from "@/lib/utils";
import { motion } from "framer-motion";

interface RelatedEntity {\n  id: string;\n  name: string;\n  type: string;\n  icon?: string;\n  color?: string;\n  connectionStrength: number; // 0-1, baseado em co-ocorrÃªncias\n}\n\ninterface RelatedEntitiesProps {\n  entityId: string;\n}\n\nconst typeColors: Record<string, string> = {\n  PERSON: \"bg-blue-500/20 text-blue-700 border-blue-500/30\",\n  HABIT: \"bg-green-500/20 text-green-700 border-green-500/30\",\n  PROJECT: \"bg-orange-500/20 text-orange-700 border-orange-500/30\",\n  GOAL: \"bg-yellow-500/20 text-yellow-700 border-yellow-500/30\",\n  DREAM: \"bg-pink-500/20 text-pink-700 border-pink-500/30\",\n  EVENT: \"bg-purple-500/20 text-purple-700 border-purple-500/30\",\n  CUSTOM: \"bg-gray-500/20 text-gray-700 border-gray-500/30\",\n};\n\nexport function RelatedEntities({ entityId }: RelatedEntitiesProps) {\n  const navigate = useNavigate();\n  const [related, setRelated] = useState<RelatedEntity[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [maxStrength, setMaxStrength] = useState(0);\n\n  useEffect(() => {\n    loadRelated();\n  }, [entityId]);\n\n  const loadRelated = async () => {\n    setLoading(true);\n    try {\n      // Tenta via endpoint especÃ­fico de relaÃ§Ãµes\n      const { data } = await api\n        .get(`/api/entities/${entityId}/related`)\n        .catch(() => ({ data: [] }));\n\n      const relatedList = Array.isArray(data) ? data : [];\n      setRelated(relatedList);\n\n      // Encontrar valor mÃ¡ximo de connectionStrength para normalizar\n      const max = Math.max(...relatedList.map((e) => e.connectionStrength || 0), 1);\n      setMaxStrength(max);\n    } catch (err) {\n      console.error(\"Erro ao carregar relaÃ§Ãµes:\", err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"space-y-2\">\n        {[1, 2, 3].map((i) => (\n          <Skeleton key={i} className=\"h-10\" />\n        ))}\n      </div>\n    );\n  }\n\n  if (related.length === 0) {\n    return (\n      <div className=\"text-center py-6 text-muted-foreground\">\n        <Network className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n        <p className=\"text-sm\">Nenhuma relaÃ§Ã£o encontrada</p>\n        <p className=\"text-xs text-muted-foreground mt-1\">\n          Essa entidade serÃ¡ conectada conforme for mencionada com outras\n        </p>\n      </div>\n    );\n  }\n\n  // Ordenar por forÃ§a de conexÃ£o\n  const sorted = [...related].sort(\n    (a, b) => (b.connectionStrength || 0) - (a.connectionStrength || 0)\n  );\n\n  return (\n    <div className=\"space-y-2\">\n      {sorted.map((entity, idx) => {\n        const strength = entity.connectionStrength || 0;\n        const percentage = maxStrength ? (strength / maxStrength) * 100 : 0;\n        const colorClass = typeColors[entity.type] || typeColors.CUSTOM;\n\n        return (\n          <motion.button\n            key={entity.id}\n            initial={{ opacity: 0, x: -10 }}\n            animate={{ opacity: 1, x: 0 }}\n            transition={{ delay: idx * 0.05 }}\n            onClick={() => navigate(`/entities/${entity.id}`)}\n            className=\"w-full text-left\"\n          >\n            <div className={cn(\n              \"flex items-center gap-3 px-3 py-2 rounded-lg border transition-all hover:shadow-md\",\n              colorClass\n            )}>\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"text-lg\">{entity.icon || \"ðŸ“Œ\"}</span>\n                  <span className=\"font-medium truncate\">{entity.name}</span>\n                  <span className=\"text-xs opacity-60 ml-auto\">\n                    {strength.toFixed(0)} conexÃµes\n                  </span>\n                </div>\n                <div className=\"mt-1 w-full bg-black/10 rounded-full h-1.5 overflow-hidden\">\n                  <div\n                    className=\"h-full bg-current rounded-full transition-all\"\n                    style={{ width: `${percentage}%` }}\n                  />\n                </div>\n              </div>\n              <ArrowRight className=\"h-4 w-4 opacity-60 flex-shrink-0\" />\n            </div>\n          </motion.button>\n        );\n      })}\n    </div>\n  );\n}\n