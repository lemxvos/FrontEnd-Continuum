/**\n * ActivityHeatmap - Visualização de atividade ao longo do tempo\n * Estilo GitHub contribution graph\n */\n\nimport { useState, useEffect } from \"react\";\nimport api from \"@/lib/axios\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { toast } from \"sonner\";\n\ninterface HeatmapDay {\n  date: string;\n  count: number;\n}\n\ninterface ActivityHeatmapProps {\n  entityId?: string;\n  months?: number;\n}\n\nconst getColor = (count: number, max: number) => {\n  if (count === 0) return \"bg-muted\";\n  const intensity = Math.min(1, count / max);\n\n  if (intensity < 0.25) return \"bg-primary/20\";\n  if (intensity < 0.5) return \"bg-primary/40\";\n  if (intensity < 0.75) return \"bg-primary/60\";\n  return \"bg-primary/100\";\n};\n\nexport function ActivityHeatmap({ entityId, months = 12 }: ActivityHeatmapProps) {\n  const [heatmap, setHeatmap] = useState<HeatmapDay[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [maxCount, setMaxCount] = useState(0);\n\n  useEffect(() => {\n    loadHeatmap();\n  }, [entityId]);\n\n  const loadHeatmap = async () => {\n    setLoading(true);\n    try {\n      const endpoint = entityId\n        ? `/api/entities/${entityId}/heatmap?months=${months}`\n        : `/api/metrics/heatmap?months=${months}`;\n      \n      const { data } = await api.get(endpoint);\n      setHeatmap(data.days || []);\n      setMaxCount(data.maxCount || 10);\n    } catch (err: any) {\n      toast.error(err.response?.data?.message || \"Erro ao carregar atividade\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  if (loading) return <Skeleton className=\"h-32 rounded-lg\" />;\n\n  // Group by week\n  const today = new Date();\n  const startDate = new Date(today);\n  startDate.setMonth(today.getMonth() - months);\n\n  const weeks: HeatmapDay[][] = [];\n  let currentWeek: HeatmapDay[] = [];\n  let currentDate = new Date(startDate);\n\n  // Fill starting day of week\n  for (let i = 0; i < currentDate.getDay(); i++) {\n    currentWeek.push({\n      date: new Date(currentDate.getTime() - (currentDate.getDay() - i) * 86400000)\n        .toISOString()\n        .split(\"T\")[0],\n      count: 0,\n    });\n  }\n\n  while (currentDate <= today) {\n    const dateStr = currentDate.toISOString().split(\"T\")[0];\n    const dayData = heatmap.find((d) => d.date === dateStr) || {\n      date: dateStr,\n      count: 0,\n    };\n\n    currentWeek.push(dayData);\n\n    if (currentWeek.length === 7) {\n      weeks.push(currentWeek);\n      currentWeek = [];\n    }\n\n    currentDate.setDate(currentDate.getDate() + 1);\n  }\n\n  if (currentWeek.length > 0) {\n    weeks.push(currentWeek);\n  }\n\n  const dayNames = [\"Dom\", \"Seg\", \"Ter\", \"Qua\", \"Qui\", \"Sex\", \"Sab\"];\n  const monthNames = [\n    \"Jan\",\n    \"Fev\",\n    \"Mar\",\n    \"Abr\",\n    \"Mai\",\n    \"Jun\",\n    \"Jul\",\n    \"Ago\",\n    \"Set\",\n    \"Out\",\n    \"Nov\",\n    \"Dez\",\n  ];\n\n  return (\n    <div className=\"space-y-4\">\n      <div>\n        <h3 className=\"text-sm font-semibold mb-3\">atividade dos últimos {months} meses</h3>\n        <div className=\"space-y-2\">\n          {/* Day labels */}\n          <div className=\"flex gap-1\">\n            <div className=\"w-12\" />\n            <div className=\"grid gap-1\" style={{\n              gridTemplateColumns: `repeat(${Math.ceil(weeks.length / 2)}, 1rem)`,\n            }}>\n              {weeks.slice(0, Math.ceil(weeks.length / 2)).map((_, idx) => {\n                const weekDate = new Date(startDate);\n                weekDate.setDate(weekDate.getDate() + idx * 7);\n                const month = monthNames[weekDate.getMonth()];\n                return (\n                  <div key={idx} className=\"text-xs text-muted-foreground\">\n                    {idx === 0 || weekDate.getDate() <= 7 ? month : \"\"}\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n\n          {/* Heatmap */}\n          <div className=\"flex gap-1\">\n            {/* Day labels column */}\n            <div className=\"flex flex-col gap-1 text-xs text-muted-foreground\">\n              {dayNames.map((day) => (\n                <div key={day} className=\"h-3\" title={day}>\n                  {day[0]}\n                </div>\n              ))}\n            </div>\n\n            {/* Weeks */}\n            <div className=\"flex gap-1 overflow-x-auto\">\n              {weeks.map((week, weekIdx) => (\n                <TooltipProvider key={weekIdx}>\n                  <div key={weekIdx} className=\"flex flex-col gap-1\">\n                    {week.map((day, dayIdx) => (\n                      <Tooltip key={`${weekIdx}-${dayIdx}`}>\n                        <TooltipTrigger asChild>\n                          <div\n                            className={`h-3 w-3 rounded-sm cursor-pointer transition-all hover:ring-1 ring-primary ${\n                              getColor(day.count, maxCount)\n                            }`}\n                            title={`${day.date}: ${day.count} atividades`}\n                          />\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"text-xs\">\n                            {new Date(day.date).toLocaleDateString(\"pt-BR\")}: {day.count}\n                          </p>\n                        </TooltipContent>\n                      </Tooltip>\n                    ))}\n                  </div>\n                </TooltipProvider>\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Legend */}\n      <div className=\"flex items-center justify-end gap-2 text-xs text-muted-foreground\">\n        <span>menos</span>\n        <div className=\"flex gap-1\">\n          {[0, 1, 2, 3, 4].map((i) => (\n            <div\n              key={i}\n              className={`h-3 w-3 rounded-sm ${\n                i === 0\n                  ? \"bg-muted\"\n                  : i === 1\n                  ? \"bg-primary/20\"\n                  : i === 2\n                  ? \"bg-primary/40\"\n                  : i === 3\n                  ? \"bg-primary/60\"\n                  : \"bg-primary/100\"\n              }`}\n            />\n          ))}\n        </div>\n        <span>mais</span>\n      </div>\n    </div>\n  );\n}\n