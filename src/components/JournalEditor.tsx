/**\n * JOURNAL EDITOR\n * \n * Editor de notas com suporte a men√ß√µes\n * \n * FLUXO:\n * 1. Usu√°rio digita conte√∫do em textarea\n * 2. Detecta padr√£o {type ou @name\n * 3. Mostra autocomplete\n * 4. Seleciona entidade\n * 5. INSERE {type:id} no texto\n * 6. Ao salvar: envia content com men√ß√µes ao backend\n * 7. Backend parseia, valida, retorna com entities[]\n * 8. Store sincroniza\n */\n\nimport { useState, useRef, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  useMentionAutocompleteState,\n  useMentionTokens,\n  insertMentionAtPosition,\n} from \"@/hooks/useMentions\";\nimport { MentionDisplay } from \"./MentionDisplay\";\nimport { EntitySelector } from \"./EntitySelector\";\nimport { useNoteStore } from \"@/stores/noteStore\";\nimport { useEntityStore } from \"@/stores/entityStore\";\nimport { Entity, CreateNotePayload, UpdateNotePayload, Note } from \"@/types/models\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface JournalEditorProps {\n  /**\n   * Se √© novo ou edi√ß√£o\n   * Se undefined = novo\n   * Se string = editando esse ID\n   */\n  noteId?: string;\n\n  // Callback ao salvar com sucesso\n  onSaveSuccess?: (note: Note) => void;\n\n  // Callback ao cancelar\n  onCancel?: () => void;\n\n  // Pasta padr√£o para new notes\n  defaultFolder?: string;\n}\n\nexport function JournalEditor({\n  noteId,\n  onSaveSuccess,\n  onCancel,\n  defaultFolder = \"inbox\",\n}: JournalEditorProps) {\n  // State local do editor\n  const [title, setTitle] = useState(\"\");\n  const [content, setContent] = useState(\"\");\n  const [folderPath, setFolderPath] = useState(defaultFolder);\n  const [cursorPos, setCursorPos] = useState(0);\n  const [isAutocompleteOpen, setIsAutocompleteOpen] = useState(false);\n  const [isSaving, setIsSaving] = useState(false);\n\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n\n  // Stores\n  const { create: createNote, update: updateNote, isLoading: notesLoading, currentNote } = useNoteStore();\n  const { lastSearchResults: suggestedEntities } = useEntityStore();\n\n  // Carrega nota se √© edit mode\n  useEffect(() => {\n    if (noteId) {\n      const note = currentNote;\n      if (note) {\n        setTitle(note.title);\n        setContent(note.content);\n        setFolderPath(note.folderPath);\n      }\n    }\n  }, [noteId, currentNote]);\n\n  // Detecta se est√° digitando men√ß√£o\n  const mentionState = useMentionAutocompleteState(content, cursorPos);\n\n  // Hook: Tokeniza men√ß√µes para preview\n  const tokens = useMentionTokens(content);\n\n  const handleTextChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setContent(e.target.value);\n    setCursorPos(e.target.selectionStart);\n  };\n\n  const handleSelectionChange = () => {\n    if (textareaRef.current) {\n      setCursorPos(textareaRef.current.selectionStart);\n    }\n  };\n\n  /**\n   * Quando usu√°rio seleciona uma entidade do autocomplete\n   * \n   * IMPORTANTE:\n   * - Insere {type:id} no texto\n   * - N√ÉO valida nada\n   * - Backend faz a valida√ß√£o ao receber\n   */\n  const handleEntitySelect = (entity: Entity) => {\n    if (mentionState && textareaRef.current) {\n      // Remove a query parcial e insere a men√ß√£o completa\n      const beforeMention = content.slice(0, mentionState.position + 1);\n      const afterMention = content.slice(cursorPos);\n\n      const fullMention = `${entity.type}:${entity.id}`;\n      const newContent = `${beforeMention}${fullMention}${afterMention}`;\n\n      setContent(newContent);\n      setIsAutocompleteOpen(false);\n\n      // Restaura foco no textarea\n      setTimeout(() => {\n        if (textareaRef.current) {\n          const newPos = beforeMention.length + fullMention.length + 1; // +1 pra fechar chave\n          textareaRef.current.focus();\n          textareaRef.current.setSelectionRange(newPos, newPos);\n          setCursorPos(newPos);\n        }\n      }, 0);\n    }\n  };\n\n  /**\n   * Salva a nota\n   */\n  const handleSave = async () => {\n    if (!title.trim() || !content.trim()) {\n      alert(\"T√≠tulo e conte√∫do s√£o obrigat√≥rios\");\n      return;\n    }\n\n    setIsSaving(true);\n    try {\n      let savedNote: Note;\n\n      if (noteId) {\n        // Edi√ß√£o\n        const payload: UpdateNotePayload = {\n          title,\n          content,\n          folderPath,\n        };\n        savedNote = await updateNote(noteId, payload);\n      } else {\n        // Cria√ß√£o\n        const payload: CreateNotePayload = {\n          title,\n          content,\n          folderPath,\n        };\n        savedNote = await createNote(payload);\n      }\n\n      onSaveSuccess?.(savedNote);\n    } catch (error: any) {\n      alert(`Erro ao salvar: ${error.message}`);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  // Se est√° carregando\n  if (noteId && notesLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen\">\n        <Loader2 className=\"animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-screen gap-4 p-4\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex-1\">\n          <Input\n            placeholder=\"T√≠tulo da nota\"\n            value={title}\n            onChange={(e) => setTitle(e.target.value)}\n            className=\"text-xl font-bold mb-2\"\n          />\n          <Input\n            placeholder=\"Caminho da pasta (ex: vida/amigos)\"\n            value={folderPath}\n            onChange={(e) => setFolderPath(e.target.value)}\n            className=\"text-sm text-gray-600\"\n          />\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" onClick={onCancel}>\n            Cancelar\n          </Button>\n          <Button onClick={handleSave} disabled={isSaving}>\n            {isSaving ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Salvando...\n              </>\n            ) : (\n              \"Salvar\"\n            )}\n          </Button>\n        </div>\n      </div>\n\n      {/* Tabs: Editor / Preview */}\n      <Tabs defaultValue=\"editor\" className=\"flex-1 flex flex-col\">\n        <TabsList>\n          <TabsTrigger value=\"editor\">Editor</TabsTrigger>\n          <TabsTrigger value=\"preview\">Preview</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"editor\" className=\"flex-1 relative\">\n          <Textarea\n            ref={textareaRef}\n            placeholder=\"Escreva sua nota aqui. Use {type:id} para mencionar entidades.\nExemplo: Sa√≠ com {person:ent_8f2a}\"\n            value={content}\n            onChange={handleTextChange}\n            onSelect={handleSelectionChange}\n            onClick={handleSelectionChange}\n            onKeyUp={handleSelectionChange}\n            className=\"h-full font-mono text-sm\"\n          />\n\n          {/* Autocomplete popup */}\n          {mentionState && (\n            <div className=\"absolute bottom-0 left-0 z-50\">\n              <EntitySelector\n                isOpen={true}\n                onOpenChange={setIsAutocompleteOpen}\n                initialQuery={mentionState.query}\n                onSelect={handleEntitySelect}\n              />\n            </div>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"preview\" className=\"flex-1 overflow-auto\">\n          <div className=\"prose prose-sm max-w-none p-4\">\n            <h1>{title}</h1>\n            <p className=\"text-gray-500 text-sm\">üìÅ {folderPath}</p>\n            <hr />\n            {/* \n              IMPORTANTE:\n              - Se a nota foi salva, `currentNote.entities` vem do backend\n              - Se n√£o foi salva, entities pode estar vazio\n              - Mostra o raw text com men√ß√µes de forma leg√≠vel\n            */}\n            <MentionDisplay\n              content={content}\n              entities={currentNote?.entities || []}\n            />\n          </div>\n        </TabsContent>\n      </Tabs>\n\n      {/* Status info */}\n      {mentionState && (\n        <div className=\"text-sm text-gray-500 px-4\">\n          üí° Digitando men√ß√£o: {mentionState.trigger}{mentionState.query}\n        </div>\n      )}\n    </div>\n  );\n}\n