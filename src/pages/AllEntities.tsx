/**
 * AllEntities - P√°gina centralizada de Entidades
 * 
 * Mostra TODAS as entidades com:
 * - Filtro por tipo
 * - Pesquisa por nome
 * - Cards com informa√ß√µes (men√ß√µes, rela√ß√£o, stats)
 * - Relacionamentos entre entidades
 */

import { useState, useEffect, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import api from "@/lib/axios";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Skeleton } from "@/components/ui/skeleton";
import { toast } from "sonner";
import { motion } from "framer-motion";
import {
  Plus,
  Search,
  Users,
  Target,
  FolderKanban,
  Star,
  Heart,
  HelpCircle,
  Zap,
  Network,
  TrendingUp,
} from "lucide-react";
import EntityCard from "@/components/EntityCard";
import LimitBanner from "@/components/LimitBanner";
import UpgradeModal from "@/components/UpgradeModal";
import { cn } from "@/lib/utils";
import {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from "@/components/ui/alert-dialog";\n\ninterface Entity {\n  id: string;\n  name: string;\n  description?: string;\n  type: string;\n  icon?: string;\n  color?: string;\n  tracking?: { enabled: boolean } | null;\n  currentStreak?: number;\n  totalCompletions?: number;\n  mentions?: number;\n  relatedCount?: number;\n  updatedAt?: string;\n  createdAt?: string;\n}\n\ninterface EntityStats {\n  PERSON?: number;\n  HABIT?: number;\n  PROJECT?: number;\n  GOAL?: number;\n  DREAM?: number;\n  EVENT?: number;\n  CUSTOM?: number;\n  total?: number;\n}\n\nconst typeFilters = [\n  { type: "ALL\", label: "Todos\", icon: Network, color: \"text-muted-foreground\" },\n  { type: \"PERSON\", label: \"Pessoas\", icon: Users, color: \"text-blue-500\" },\n  { type: \"HABIT\", label: \"H√°bitos\", icon: Target, color: \"text-green-500\" },\n  { type: \"PROJECT\", label: \"Projetos\", icon: FolderKanban, color: \"text-orange-500\" },\n  { type: \"GOAL\", label: \"Objetivos\", icon: Star, color: \"text-yellow-500\" },\n  { type: \"DREAM\", label: \"Sonhos\", icon: Heart, color: \"text-pink-500\" },\n  { type: \"EVENT\", label: \"Eventos\", icon: Zap, color: \"text-purple-500\" },\n  { type: \"CUSTOM\", label: \"Custom\", icon: HelpCircle, color: \"text-gray-500\" },\n];\n\nconst iconMap: Record<string, typeof Users> = {\n  PERSON: Users,\n  HABIT: Target,\n  PROJECT: FolderKanban,\n  GOAL: Star,\n  DREAM: Heart,\n  EVENT: Zap,\n  CUSTOM: HelpCircle,\n};\n\nexport default function AllEntitiesPage() {\n  const navigate = useNavigate();\n  const [entities, setEntities] = useState<Entity[]>([]);\n  const [stats, setStats] = useState<EntityStats>({});\n  const [loading, setLoading] = useState(true);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [selectedType, setSelectedType] = useState<string>(\"ALL\");\n  const [sortBy, setSortBy] = useState<\"recent\" | \"mentions\" | \"name\">(\"recent\");\n  const [upgradeOpen, setUpgradeOpen] = useState(false);\n  const [deleteTarget, setDeleteTarget] = useState<Entity | null>(null);\n\n  useEffect(() => {\n    loadEntities();\n  }, []);\n\n  const loadEntities = async () => {\n    setLoading(true);\n    try {\n      const [entitiesRes, statsRes] = await Promise.all([\n        api.get(\"/api/entities\"),\n        api.get(\"/api/metrics/dashboard\").catch(() => ({ data: {} })),\n      ]);\n\n      const entitiesList = Array.isArray(entitiesRes.data) ? entitiesRes.data : [];\n      setEntities(entitiesList);\n\n      // Extrair stats\n      const dashboardStats: EntityStats = {};\n      dashboardStats.PERSON = statsRes.data.uniquePeople || 0;\n      dashboardStats.HABIT = statsRes.data.uniqueHabits || 0;\n      dashboardStats.PROJECT = statsRes.data.uniqueProjects || 0;\n      dashboardStats.GOAL = statsRes.data.uniqueGoals || 0;\n      dashboardStats.DREAM = statsRes.data.uniqueDreams || 0;\n      dashboardStats.total =\n        entitiesList.length ||\n        (Object.values(dashboardStats).reduce((a, b) => a + (b || 0), 0) as number);\n\n      setStats(dashboardStats);\n      // Check limit\n      if (statsRes.data.limitReached) {\n        setUpgradeOpen(true);\n      }\n    } catch (err: any) {\n      if (err.response?.status === 403) setUpgradeOpen(true);\n      else toast.error(err.response?.data?.message || \"Erro ao carregar\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const filteredEntities = useMemo(() => {\n    let result = entities;\n\n    // Filtro por tipo\n    if (selectedType !== \"ALL\") {\n      result = result.filter(\n        (e) => (e.type || \"CUSTOM\").toUpperCase() === selectedType\n      );\n    }\n\n    // Filtro por pesquisa\n    if (searchQuery.trim()) {\n      const q = searchQuery.toLowerCase();\n      result = result.filter(\n        (e) =>\n          (e.name || \"\").toLowerCase().includes(q) ||\n          (e.description || \"\").toLowerCase().includes(q)\n      );\n    }\n\n    // Ordena√ß√£o\n    if (sortBy === \"mentions\") {\n      result.sort((a, b) => (b.mentions || 0) - (a.mentions || 0));\n    } else if (sortBy === \"name\") {\n      result.sort((a, b) => (a.name || \"\").localeCompare(b.name || \"\"));\n    } else {\n      // recent\n      result.sort(\n        (a, b) =>\n          new Date(b.updatedAt || b.createdAt || 0).getTime() -\n          new Date(a.updatedAt || a.createdAt || 0).getTime()\n      );\n    }\n\n    return result;\n  }, [entities, selectedType, searchQuery, sortBy]);\n\n  const handleDelete = async () => {\n    if (!deleteTarget) return;\n    try {\n      await api.delete(`/api/entities/${deleteTarget.id}`);\n      setEntities((prev) => prev.filter((e) => e.id !== deleteTarget.id));\n      toast.success(\"Entidade removida!\");\n    } catch (err: any) {\n      toast.error(err.response?.data?.message || \"Erro ao deletar\");\n    } finally {\n      setDeleteTarget(null);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">\n            üåç Entidades ({stats.total || entities.length})\n          </h1>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            Centralize tudo que importa. Pessoas, projetos, h√°bitos e mais.\n          </p>\n        </div>\n        <Button\n          onClick={() => navigate(\"/entities/new\")}\n          size=\"lg\"\n          className=\"gap-2\"\n        >\n          <Plus className=\"h-4 w-4\" />\n          Nova Entidade\n        </Button>\n      </div>\n\n      {/* Stats */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\n        {[\n          { label: \"Pessoas\", value: stats.PERSON || 0, icon: Users },\n          { label: \"H√°bitos\", value: stats.HABIT || 0, icon: Target },\n          { label: \"Projetos\", value: stats.PROJECT || 0, icon: FolderKanban },\n          { label: \"Outros\", value: (stats.GOAL || 0) + (stats.DREAM || 0) + (stats.EVENT || 0) + (stats.CUSTOM || 0), icon: Zap },\n        ].map((stat) => (\n          <motion.div\n            key={stat.label}\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"p-3 rounded-lg bg-accent border border-border\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <stat.icon className=\"h-4 w-4 text-muted-foreground\" />\n              <div>\n                <p className=\"text-xs text-muted-foreground\">{stat.label}</p>\n                <p className=\"text-lg font-bold\">{stat.value}</p>\n              </div>\n            </div>\n          </motion.div>\n        ))}\n      </div>\n\n      {/* Limite */}\n      <LimitBanner />\n\n      {/* Filtros */}\n      <div className=\"space-y-4 bg-card border border-border rounded-lg p-4\">\n        <div className=\"space-y-2\">\n          <label className=\"text-sm font-medium\">Buscar</label>\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Buscar por nome ou descri√ß√£o...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10\"\n            />\n          </div>\n        </div>\n\n        <div className=\"space-y-2\">\n          <label className=\"text-sm font-medium\">Tipo</label>\n          <div className=\"flex flex-wrap gap-2\">\n            {typeFilters.map((filter) => {\n              const Icon = filter.icon;\n              return (\n                <button\n                  key={filter.type}\n                  onClick={() => setSelectedType(filter.type)}\n                  className={cn(\n                    \"flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors border\",\n                    selectedType === filter.type\n                      ? \"bg-primary text-primary-foreground border-primary\"\n                      : \"bg-background border-border hover:border-primary hover:bg-accent\"\n                  )}\n                >\n                  <Icon className=\"h-4 w-4\" />\n                  {filter.label}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n\n        <div className=\"space-y-2\">\n          <label className=\"text-sm font-medium\">Ordenar por</label>\n          <div className=\"flex gap-2\">\n            {[\n              { value: \"recent\", label: \"Recentes\" },\n              { value: \"mentions\", label: \"Men√ß√µes\" },\n              { value: \"name\", label: \"Nome\" },\n            ].map((option) => (\n              <button\n                key={option.value}\n                onClick={() => setSortBy(option.value as any)}\n                className={cn(\n                  \"px-3 py-1.5 rounded-lg text-sm font-medium transition-colors border\",\n                  sortBy === option.value\n                    ? \"bg-primary text-primary-foreground border-primary\"\n                    : \"bg-background border-border hover:border-primary hover:bg-accent\"\n                )}\n              >\n                {option.label}\n              </button>\n            ))}\n          </div>\n        </div>\n      </div>\n\n      {/* Loading */}\n      {loading && (\n        <div className=\"space-y-3\">\n          {[1, 2, 3, 4].map((i) => (\n            <Skeleton key={i} className=\"h-24 rounded-lg\" />\n          ))}\n        </div>\n      )}\n\n      {/* Entidades */}\n      {!loading && filteredEntities.length === 0 && (\n        <div className=\"text-center py-12\">\n          <Network className=\"h-12 w-12 text-muted-foreground mx-auto mb-3\" />\n          <p className=\"text-muted-foreground\">\n            {searchQuery || selectedType !== \"ALL\"\n              ? \"Nenhuma entidade encontrada\"\n              : \"Crie sua primeira entidade para come√ßar\"}\n          </p>\n          <Button\n            variant=\"ghost\"\n            onClick={() => navigate(\"/entities/new\")}\n            className=\"mt-3\"\n          >\n            Criar entidade\n          </Button>\n        </div>\n      )}\n\n      {!loading && filteredEntities.length > 0 && (\n        <motion.div\n          className=\"grid gap-3\"\n          layout\n        >\n          <p className=\"text-sm text-muted-foreground\">\n            {filteredEntities.length} entidade{filteredEntities.length !== 1 ? \"s\" : \"\"}\n          </p>\n          {filteredEntities.map((entity, idx) => (\n            <motion.div\n              key={entity.id}\n              initial={{ opacity: 0, x: -10 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ delay: idx * 0.05 }}\n            >\n              <EntityCard\n                entity={entity}\n                onClick={() => navigate(`/entities/${entity.id}`)}\n                onDelete={() => setDeleteTarget(entity)}\n              />\n            </motion.div>\n          ))}\n        </motion.div>\n      )}\n\n      {/* Delete Dialog */}\n      <AlertDialog open={!!deleteTarget} onOpenChange={(open) => !open && setDeleteTarget(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Deletar entidade?</AlertDialogTitle>\n            <AlertDialogDescription>\n              \"{deleteTarget?.name}\" ser√° removida permanentemente.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction onClick={handleDelete} className=\"bg-destructive\">\n              Deletar\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Upgrade Modal */}\n      <UpgradeModal open={upgradeOpen} onOpenChange={setUpgradeOpen} />\n    </div>\n  );\n}
